name: Coverage Badge

on: workflow_call

jobs:
  code-coverage-badge:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - name: ‚§µÔ∏è Download Artifact (base code coverage results)
        if: github.event_name == 'pull_request'
        uses: dawidd6/action-download-artifact@v2
        id: restoreCodeCoverage
        with:
          workflow: ci-nx.yaml
          workflow_conclusion: success
          branch: main
          name: code-coverage-report
          path: ./coverage-base
        continue-on-error: true

      - name: üìî Create Coverage Badge
        uses: dkhunt27/nx-code-coverage@v0.3.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          coverage-folder: ./coverage
          coverage-base-folder: ./coverage-base
          gist-token: ${{ secrets.COVERAGE_BADGES_GIST_TOKEN }}
          # https://gist.github.com/akhenda/e87e6f67fa5b4ffc5757bc946b8db87a
          gist-id: e87e6f67fa5b4ffc5757bc946b8db87a
          color: green
          named-logo: jest
          filename: test

      - name: üìî Generate coverage branch
        uses: team-tenacious/monorepo-coverage@main
        with:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
          COVERAGE_BRANCH: coverage
          ROOT: './libs'
          PACKAGES: browserslist-config
