name: Coverage Badge

on: workflow_call

jobs:
  code-coverage-badge:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - name: ‚§µÔ∏è Download artifact (base code coverage results)
        if: github.event_name == 'pull_request'
        uses: dawidd6/action-download-artifact@v2
        id: restored-code-coverage
        with:
          workflow: ci-nx.yaml
          workflow_conclusion: success
          branch: main
          name: coverage
          path: coverage-base
          if_no_artifact_found: ignore
        continue-on-error: true

      - name: Download code coverage results
        uses: actions/download-artifact@v3
        with:
          name: coverage
          path: coverage

      - name: Display structure of downloaded files
        run: ls -R

      - name: üìî Create coverage badge
        # if: steps.restored-code-coverage.outputs.found_artifact == 'true'
        uses: dkhunt27/nx-code-coverage@v1
        with:
          no-coverage-ran: false
          github-token: ${{ secrets.GITHUB_TOKEN }}
          coverage-folder: ./coverage
          coverage-base-folder: ./coverage-base
          gist-token: ${{ secrets.COVERAGE_BADGES_GIST_TOKEN }}
          # https://gist.github.com/akhenda/e87e6f67fa5b4ffc5757bc946b8db87a
          gist-id: e87e6f67fa5b4ffc5757bc946b8db87a
          color: green
          named-logo: jest

      - name: üìî Generate coverage branch
        uses: team-tenacious/monorepo-coverage@main
        with:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
          COVERAGE_BRANCH: coverage
          ROOT: './coverage/libs'
          PACKAGES: browserslist-config
